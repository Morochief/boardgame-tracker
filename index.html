<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üé≤ Boardgame Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { 'gaming': ['Orbitron', 'sans-serif'], 'body': ['Inter', 'sans-serif'] }, colors: { 'neon-violet': '#a855f7', 'neon-cyan': '#22d3ee', 'neon-pink': '#ec4899', 'neon-red': '#ef4444', 'dark-bg': '#0f172a' } } } }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* --- ESTILOS DE JUSTICIA (ROJO NE√ìN) --- */
        .glass-danger { 
            background: rgba(69, 10, 10, 0.8); 
            backdrop-filter: blur(12px); 
            border: 1px solid #ef4444; 
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.4); 
        }
        .glass-success { background: rgba(6, 78, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(16, 185, 129, 0.3); }
        .offender-badge {
            background-color: rgba(127, 29, 29, 0.8);
            color: #fca5a5;
            border: 1px solid #ef4444;
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
            display: inline-block;
            margin: 2px;
        }

        .bg-orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.2; z-index: 0; animation: float 10s ease-in-out infinite; }
        .section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .section.active { display: block; opacity: 1; }
        .nav-btn.active { color: #22d3ee; background: rgba(34, 211, 238, 0.1); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2); }
        .swal2-popup { background: #1e293b !important; border: 1px solid #334155 !important; color: #fff !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        /* Login & Profiles */
        #loginScreen { position: fixed; inset: 0; z-index: 100; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        #loginScreen.hidden { display: none; }
        .profile-card { width: 120px; cursor: pointer; transition: all 0.3s; }
        .profile-card:hover { transform: scale(1.1); }
        .profile-avatar { width: 100px; height: 100px; border-radius: 12px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 3rem; position: relative; border: 3px solid transparent; }
        .profile-avatar.has-lock::after { content: 'üîí'; position: absolute; bottom: 4px; right: 4px; font-size: 1rem; background: rgba(0,0,0,0.7); border-radius: 4px; padding: 2px; }
        .profile-avatar.is-observer::after { content: 'üëÅÔ∏è'; position: absolute; top: 4px; left: 4px; font-size: 1.2rem; background: rgba(0,0,0,0.7); border-radius: 4px; padding: 2px; }
        
        /* Badge Superior Derecha */
        .current-user-badge { 
            position: fixed; top: 20px; right: 20px; z-index: 60; 
            display: flex; align-items: center; gap: 10px; 
            padding: 8px 16px; border-radius: 20px; 
            background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; transition: all 0.3s ease; 
        }
        .current-user-badge:hover { background: rgba(168, 85, 247, 0.3); border-color: #a855f7; }
        @media (max-width: 768px) { .current-user-badge { top: 75px; right: 10px; padding: 6px 12px; } }

        /* Observer Restriction */
        .observer-hidden { display: none !important; }

        /* Avatars */
        .avatar-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .avatar-orange { background: linear-gradient(135deg, #f97316, #ea580c); }
        .avatar-yellow { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .avatar-green { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .avatar-cyan { background: linear-gradient(135deg, #22d3ee, #06b6d4); }
        .avatar-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .avatar-violet { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .avatar-pink { background: linear-gradient(135deg, #ec4899, #db2777); }
        
        /* PIN & Admin */
        .pin-container { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .pin-digit { width: 50px; height: 60px; background: #1e293b; border: 2px solid #475569; border-radius: 8px; font-size: 24px; color: white; text-align: center; }
        .pin-digit:focus { border-color: #a855f7; outline: none; }
        .pin-digit.filled { border-color: #a855f7; background: rgba(168,85,247,0.1); }
        .glass-admin { background: rgba(234, 179, 8, 0.15); backdrop-filter: blur(12px); border: 1px solid rgba(234, 179, 8, 0.4); }
        .avatar-selector, .color-selector { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
        .avatar-option, .color-option { cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .avatar-option:hover, .color-option:hover { transform: scale(1.1); }
        .avatar-option.selected, .color-option.selected { border-color: white; box-shadow: 0 0 10px white; }
    </style>
</head>
<body class="min-h-screen">

    <div id="currentUserBadge" onclick="logout()" class="current-user-badge hidden">
        <div id="currentUserAvatar" class="w-8 h-8 rounded-md flex items-center justify-center text-lg font-bold"></div>
        <span id="currentUserName" class="text-sm text-white font-bold hidden md:inline"></span>
        <i class="fas fa-sign-out-alt text-slate-400 text-xs ml-1"></i>
    </div>

    <div id="loginScreen">
        <div class="bg-orb w-64 h-64 bg-purple-600 top-0 left-0"></div>
        <div class="bg-orb w-96 h-96 bg-cyan-600 bottom-0 right-0"></div>
        <div class="relative z-10 w-full max-w-3xl flex flex-col items-center">
            <div class="mb-10 text-center">
                <i class="fas fa-dice-d20 text-5xl text-neon-cyan mb-4"></i>
                <h1 class="font-gaming text-4xl bg-gradient-to-r from-neon-cyan to-neon-violet bg-clip-text text-transparent">BG TRACKER</h1>
                <p class="text-slate-400">Selecciona tu perfil</p>
            </div>
            <div id="profilesGrid" class="flex flex-wrap justify-center gap-6">
                <p class="text-slate-500 animate-pulse">Cargando perfiles...</p>
            </div>
            <button onclick="requestAdminAccess()" class="mt-12 text-xs text-yellow-500 border border-yellow-500/30 px-4 py-2 rounded-full hover:bg-yellow-500/10">
                <i class="fas fa-cog"></i> Administrar
            </button>
        </div>
    </div>

    <div id="adminSetupScreen" class="fixed inset-0 z-[200] bg-slate-900 hidden flex items-center justify-center p-4">
        <div class="glass-admin p-8 rounded-2xl text-center max-w-sm w-full">
            <h2 class="text-yellow-400 font-bold text-xl mb-4">Configurar Admin</h2>
            <p class="text-xs text-slate-300 mb-4">Crea un PIN maestro para gestionar perfiles.</p>
            <div class="pin-container" id="setupAdminPin"><input type="password" class="pin-digit" maxlength="1"><input type="password" class="pin-digit" maxlength="1"><input type="password" class="pin-digit" maxlength="1"><input type="password" class="pin-digit" maxlength="1"></div>
            <button onclick="saveAdminPin()" class="bg-yellow-600 text-black font-bold py-3 px-6 rounded-xl w-full hover:bg-yellow-500">Guardar</button>
        </div>
    </div>

    <div id="pinModal" class="fixed inset-0 z-[150] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass p-8 rounded-2xl text-center max-w-xs w-full border border-slate-600">
            <div id="pinAvatarDisplay" class="w-20 h-20 mx-auto rounded-xl flex items-center justify-center text-4xl mb-4"></div>
            <h3 id="pinUserTitle" class="text-white font-bold text-lg mb-2"></h3>
            <p class="text-xs text-slate-400 mb-4">Ingresa tu PIN</p>
            <div class="pin-container" id="loginPin"><input type="password" class="pin-digit" maxlength="1"><input type="password" class="pin-digit" maxlength="1"><input type="password" class="pin-digit" maxlength="1"><input type="password" class="pin-digit" maxlength="1"></div>
            <button onclick="closePinModal()" class="text-slate-500 text-sm mt-4">Cancelar</button>
        </div>
    </div>

    <div id="editProfileModal" class="fixed inset-0 z-[160] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-admin p-6 rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 id="editProfileTitle" class="text-yellow-400 font-bold text-xl mb-4 text-center">Editar Perfil</h3>
            <input type="hidden" id="editProfileId">
            
            <div class="mb-4 text-center">
                <div id="previewAvatar" class="w-24 h-24 mx-auto rounded-xl flex items-center justify-center text-5xl mb-2 transition-all"></div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Nombre</label>
                    <input id="profileNameInput" type="text" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-yellow-500">
                </div>
                
                <div class="flex items-center gap-3 bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                    <input type="checkbox" id="profileIsObserver" class="w-5 h-5 accent-yellow-500">
                    <label for="profileIsObserver" class="text-sm text-slate-300 select-none">Modo Observador (Solo ver) üëÅÔ∏è</label>
                </div>

                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Avatar</label>
                    <div id="emojiSelector" class="avatar-selector"></div>
                </div>
                
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Color</label>
                    <div id="colorSelector" class="color-selector"></div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeEditProfileModal()" class="flex-1 py-3 border border-slate-600 text-slate-300 rounded-xl">Cancelar</button>
                <button onclick="saveProfile()" class="flex-1 py-3 bg-yellow-600 text-black font-bold rounded-xl hover:bg-yellow-500">Guardar</button>
            </div>
            <div id="adminActions" class="mt-4 pt-4 border-t border-slate-700 hidden">
                <button onclick="deleteProfile()" class="w-full text-red-400 text-sm py-2 hover:bg-red-900/20 rounded">Eliminar Perfil</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        
        <header class="md:hidden glass sticky top-0 z-50 p-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-dice-d20 text-neon-cyan text-xl"></i>
                <h1 class="font-gaming font-bold text-lg bg-gradient-to-r from-neon-cyan to-neon-violet bg-clip-text text-transparent">BG TRACKER</h1>
            </div>
            <div id="statusIndicator" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_red]"></div>
        </header>

        <nav class="hidden md:flex fixed left-0 top-0 h-full w-64 glass flex-col p-6 z-40 border-r border-slate-800">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-neon-violet to-neon-cyan flex items-center justify-center">
                    <i class="fas fa-dice-d20 text-white"></i>
                </div>
                <div>
                    <h1 class="font-gaming font-bold text-lg">BG TRACKER</h1>
                    <p id="desktopStatus" class="text-[10px] text-red-400">‚óè Desconectado</p>
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <button onclick="nav('dashboard')" class="nav-btn active flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="dashboard"><i class="fas fa-chart-pie w-5"></i> Dashboard</button>
                <button onclick="nav('analytics')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="analytics"><i class="fas fa-chart-line w-5"></i> Analytics</button>
                <button onclick="nav('justice')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="justice"><i class="fas fa-balance-scale w-5"></i> Justicia</button>
                <button id="navRegister" onclick="nav('register')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="register"><i class="fas fa-plus-circle w-5"></i> Nueva Partida</button>
                <button onclick="nav('history')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="history"><i class="fas fa-history w-5"></i> Historial</button>
                <button id="navSettings" onclick="nav('settings')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="settings"><i class="fas fa-cog w-5"></i> Configuraci√≥n</button>
            </div>
        </nav>

        <main class="max-w-5xl mx-auto p-4 md:p-8 relative z-10 pb-24 md:pb-8 md:pl-64">
            <section id="dashboard" class="section active">
                <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span class="text-neon-violet">üìä</span> Estad√≠sticas</h2>
                <div id="dashboardAlert" class="hidden mb-6 bg-red-500/10 border border-red-500/50 p-3 rounded-xl flex items-center justify-between cursor-pointer hover:bg-red-500/20 transition-all" onclick="nav('justice')">
                    <div class="flex items-center gap-3"><div class="animate-pulse w-2 h-2 bg-red-500 rounded-full"></div><span class="text-red-300 text-sm font-bold">¬°Hay sanciones activas!</span></div>
                    <i class="fas fa-chevron-right text-red-400"></i>
                </div>
                <div class="glass p-4 rounded-2xl mb-6 text-center"><p class="text-slate-400 text-xs uppercase mb-1">Partidas Jugadas</p><p id="kpiTotal" class="font-gaming text-5xl text-white">0</p></div>
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="mvp-card p-5 rounded-2xl relative z-10"><div class="relative z-10"><div class="flex items-center justify-between mb-3"><p class="text-slate-300 text-xs uppercase font-bold flex items-center gap-2"><i class="fas fa-trophy text-yellow-400"></i> MVP</p><button onclick="toggleRanking('players')" class="text-xs text-neon-cyan hover:underline"><span id="togglePlayersText">Ver Top 5</span></button></div><div id="mvpMain" class="flex items-center gap-4"><div class="w-14 h-14 rounded-full bg-gradient-to-br from-neon-cyan to-neon-violet flex items-center justify-center text-2xl">üëë</div><div><p id="kpiMVPName" class="font-gaming text-2xl text-neon-cyan">-</p><p id="kpiMVPWins" class="text-sm text-slate-400">0 victorias</p></div></div><div id="playersRanking" class="expand-content mt-4"><div class="border-t border-slate-700 pt-3 space-y-2" id="playersRankingList"></div></div></div></div>
                    <div class="game-card p-5 rounded-2xl"><div class="flex items-center justify-between mb-3"><p class="text-slate-300 text-xs uppercase font-bold flex items-center gap-2"><i class="fas fa-fire text-neon-pink"></i> Juego Favorito</p><button onclick="toggleRanking('games')" class="text-xs text-neon-pink hover:underline"><span id="toggleGamesText">Ver Top 5</span></button></div><div id="gameMain" class="flex items-center gap-4"><div class="w-14 h-14 rounded-full bg-gradient-to-br from-neon-pink to-neon-violet flex items-center justify-center text-2xl">üé≤</div><div><p id="kpiGameName" class="font-gaming text-2xl text-neon-pink">-</p><p id="kpiGameCount" class="text-sm text-slate-400">0 partidas</p></div></div><div id="gamesRanking" class="expand-content mt-4"><div class="border-t border-slate-700 pt-3 space-y-2" id="gamesRankingList"></div></div></div>
                </div>
                <div class="grid md:grid-cols-2 gap-6"><div class="glass p-5 rounded-2xl"><h3 class="text-sm font-bold mb-4 text-slate-300">Victorias</h3><div class="h-48"><canvas id="chartWins"></canvas></div></div><div class="glass p-5 rounded-2xl"><h3 class="text-sm font-bold mb-4 text-slate-300">Juegos</h3><div class="h-48"><canvas id="chartGames"></canvas></div></div></div>
            </section>

            <section id="analytics" class="section">
                <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2 text-neon-cyan"><i class="fas fa-chart-line"></i> Analytics</h2>
                <div class="glass p-5 rounded-2xl mb-6"><h3 class="font-bold mb-4 text-slate-300 flex items-center gap-2"><i class="fas fa-percentage text-neon-cyan"></i> Tasa de Efectividad (Win Rate)</h3><p class="text-xs text-slate-500 mb-4">Min. 3 partidas jugadas.</p><div class="h-64"><canvas id="chartWinRate"></canvas></div></div>
                <div class="glass p-5 rounded-2xl"><h3 class="font-bold mb-4 text-slate-300">Detalle</h3><div id="analyticsTable" class="space-y-2"></div></div>
            </section>

            <section id="justice" class="section">
                <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2 text-neon-red"><span class="text-3xl">‚öñÔ∏è</span> Sala de Justicia</h2>
                <div id="wallOfShameCard" class="mb-8 p-6 rounded-2xl transition-all duration-500"></div>
                <div class="glass p-6 rounded-2xl">
                    <h3 class="font-gaming text-lg mb-4 text-slate-300 flex items-center gap-2"><i class="fas fa-calendar-times text-slate-500"></i> Bit√°cora de Ausencias</h3>
                    <div id="absenceBoard" class="space-y-3 max-h-[500px] overflow-y-auto pr-2"></div>
                </div>
            </section>

            <section id="register" class="section">
                <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span id="registerIcon" class="text-neon-cyan">üéØ</span> <span id="registerTitle">Nueva Partida</span></h2>
                <div id="registerCard" class="glass p-6 rounded-2xl max-w-xl mx-auto">
                    <input type="hidden" id="editMatchId">
                    <div id="editModeBanner" class="hidden mb-4 bg-amber-500/20 border border-amber-500/50 p-3 rounded-xl flex justify-between items-center"><div class="flex gap-2 text-amber-400"><i class="fas fa-edit"></i> Editando</div><button onclick="cancelEditMatch()" class="text-xs underline">Cancelar</button></div>
                    <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Fecha</label><input type="date" id="inputDate" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white"></div>
                    <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Juego</label><select id="inputGame" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white" onchange="updateGameMode()"><option>Selecciona...</option></select><p id="gameModeHint" class="text-xs mt-2 text-neon-pink hidden"><i class="fas fa-calculator"></i> Modo Puntos</p></div>
                    <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Jugadores</label><div id="gridPlayers" class="grid grid-cols-3 gap-2"></div></div>
                    <div id="sectionScores" class="mb-5 hidden"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Puntajes</label><div id="gridScores" class="grid grid-cols-2 gap-3"></div></div>
                    <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Ganador</label><select id="inputWinner" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white" disabled><option>Ganador...</option></select></div>
                    <div class="mb-6"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Notas</label><textarea id="inputNotes" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white text-sm" rows="2"></textarea></div>
                    <button id="btnSubmitMatch" onclick="submitMatch()" class="w-full py-4 bg-gradient-to-r from-neon-violet to-neon-cyan rounded-xl font-gaming font-bold text-black hover:scale-[1.02] transition-transform">GUARDAR</button>
                </div>
            </section>

            <section id="history" class="section">
                <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span class="text-neon-pink">üìú</span> Historial</h2>
                <div id="listHistory" class="space-y-3 pb-20"></div>
            </section>

            <section id="settings" class="section">
                <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span class="text-slate-400">‚öôÔ∏è</span> Ajustes</h2>
                <div class="mb-6 bg-blue-900/20 border border-blue-500/30 p-4 rounded-xl text-center"><p class="text-sm text-blue-200">‚òÅÔ∏è <strong>Sincronizaci√≥n Total:</strong> Los cambios se ver√°n en todos los dispositivos.</p></div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="glass p-5 rounded-2xl"><h3 class="font-bold mb-4 text-neon-cyan">Jugadores</h3><div class="bg-slate-800/50 p-3 rounded-xl mb-4"><div class="grid grid-cols-2 gap-2 mb-2"><input id="playerNick" placeholder="Nick" class="bg-slate-900 border border-slate-600 rounded p-2 text-sm w-full text-white"><input id="playerReal" placeholder="Nombre" class="bg-slate-900 border border-slate-600 rounded p-2 text-sm w-full text-white"></div><button onclick="savePlayer()" class="w-full bg-slate-700 text-white py-2 rounded text-xs">AGREGAR</button></div><div id="listPlayers" class="flex flex-col gap-2"></div></div>
                    <div class="glass p-5 rounded-2xl"><h3 class="font-bold mb-4 text-neon-violet">Juegos</h3><div class="bg-slate-800/50 p-3 rounded-xl mb-4"><input id="newGameName" placeholder="Juego" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mb-2 text-white"><div class="flex gap-2 mb-2"><button id="btnTypeDirect" onclick="setGameType('direct')" class="flex-1 text-xs py-2 border rounded text-white">Directo</button><button id="btnTypeScore" onclick="setGameType('score')" class="flex-1 text-xs py-2 border rounded text-slate-400">Puntos</button></div><button onclick="saveGame()" class="w-full bg-slate-700 text-white py-2 rounded text-xs">AGREGAR</button></div><div id="listGames" class="space-y-2"></div></div>
                </div>
            </section>
        </main>

        <nav class="md:hidden fixed bottom-0 w-full glass border-t border-slate-800 p-2 z-50 flex justify-around">
            <button onclick="nav('dashboard')" class="nav-btn active flex flex-col items-center p-2 rounded-lg text-xs" data-target="dashboard"><i class="fas fa-chart-pie text-lg mb-1"></i></button>
            <button onclick="nav('analytics')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="analytics"><i class="fas fa-chart-line text-lg mb-1"></i></button>
            <button id="mobRegister" onclick="nav('register')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="register"><i class="fas fa-plus-circle text-2xl mb-1 text-neon-cyan"></i></button>
            <button onclick="nav('justice')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="justice"><i class="fas fa-balance-scale text-lg mb-1"></i></button>
            <button id="mobSettings" onclick="nav('settings')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="settings"><i class="fas fa-cog text-lg mb-1"></i></button>
        </nav>
    </div>

    <script>
        const SB_URL = 'https://fgdeurowjawiseehoetr.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnZGV1cm93amF3aXNlZWhvZXRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDgxMjksImV4cCI6MjA4MzcyNDEyOX0.abfEkpQgjUXfr0BVeu-6s6dRBxAIqyALfu0ILdLk7VA';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        // Assets
        const AVATAR_EMOJIS = ['üòÄ', 'üòé', 'ü§ì', 'üòà', 'üëª', 'ü§ñ', 'üëΩ', 'üéÆ', 'üé≤', 'üÉè', 'ü¶ä', 'üê±', 'üê∂', 'ü¶Å', 'üê∏', 'ü¶Ñ'];
        const AVATAR_COLORS = ['red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'violet', 'pink'];

        // State
        let adminPin = null, profiles = [], currentUser = null, isAdminMode = false;
        let selectedEmoji = 'üòÄ', selectedColor = 'violet';
        let config = { players: [], games: [] }, matches = [], activePlayers = [];
        let selectedGameType = 'direct', pendingProfile = null, mySubscription = null;

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            initCharts(); await loadAdminPin(); await loadProfiles();
            if (!adminPin) { showAdminSetup(); } 
            else {
                renderProfiles(); setupAllPinInputs(); renderAvatarSelectors();
                const savedUser = sessionStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const saved = JSON.parse(savedUser);
                        const found = profiles.find(p => p.id === saved.id);
                        if (found) { currentUser = found; updateCurrentUserBadge(); await enterApp(); } 
                        else { sessionStorage.removeItem('currentUser'); }
                    } catch (e) { console.error(e); }
                }
            }
        });

        // Utils
        function simpleHash(str) { let hash = 0; for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash |= 0; } return Math.abs(hash).toString(16); }
        function toast(msg) { Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: msg, showConfirmButton: false, timer: 2000, background: '#1e293b', color: '#fff' }); }
        function setOnlineStatus(online) { const i=document.getElementById('statusIndicator'), d=document.getElementById('desktopStatus'); if(online){i.classList.replace('bg-red-500','bg-green-500'); if(d){d.innerText='‚óè Conectado';d.className='text-[10px] text-green-400';}} else {i.classList.replace('bg-green-500','bg-red-500'); if(d){d.innerText='‚óè Desconectado';d.className='text-[10px] text-red-400';}} }

        // Data & Sync (CORREGIDO)
        async function loadAllData() {
            const st = document.getElementById('desktopStatus'); if (st) st.innerText = '‚óè Sincronizando...';
            try {
                const { data: cfg } = await sbClient.from('app_config').select('data').eq('key', 'main_config').single();
                if (cfg) { config = cfg.data; config.players.sort((a,b)=>a.nickname.localeCompare(b.nickname)); config.games.sort((a,b)=>a.name.localeCompare(b.name)); }
                const { data: m } = await sbClient.from('matches').select('*').order('played_date',{ascending:false});
                if(m) matches = m;
                setOnlineStatus(true); updateUI(); renderJusticeModule(); renderSettings(); renderAnalyticsModule();
            } catch(e){ setOnlineStatus(false); }
        }
        async function saveConfig() { await sbClient.from('app_config').upsert({key:'main_config',data:config},{onConflict:'key'}); renderSettings(); }
        async function loadAdminPin() { try{const{data}=await sbClient.from('app_config').select('data').eq('key','admin_pin').single(); if(data) adminPin=data.data.pin;}catch(e){} }
        async function saveAdminToCloud(p) { await sbClient.from('app_config').upsert({key:'admin_pin',data:{pin:p}},{onConflict:'key'}); }
        
        // CORRECCI√ìN CR√çTICA DE CARGA DE PERFILES
        async function loadProfiles() {
            try {
                const { data, error } = await sbClient.from('app_config').select('data').eq('key', 'user_profiles').single();
                if (data && data.data) {
                    if (Array.isArray(data.data)) profiles = data.data;
                    else if (data.data.data && Array.isArray(data.data.data)) profiles = data.data.data;
                    else profiles = [];
                } else { profiles = []; }
                if (!document.getElementById('loginScreen').classList.contains('hidden')) renderProfiles();
            } catch (e) { console.error('Load Profiles Error', e); profiles = []; }
        }

        async function saveProfiles() { await sbClient.from('app_config').upsert({key:'user_profiles',data:profiles},{onConflict:'key'}); }
        function setupRealtime() {
            if(mySubscription) sbClient.removeChannel(mySubscription);
            mySubscription = sbClient.channel('public:all').on('postgres_changes',{event:'*',schema:'public'}, ()=>{ loadAllData(); loadProfiles(); toast('Datos actualizados'); }).subscribe(s=>{if(s==='SUBSCRIBED')setOnlineStatus(true);});
        }

        // Login Logic
        function showAdminSetup() { document.getElementById('adminSetupScreen').classList.remove('hidden'); document.getElementById('loginScreen').classList.add('hidden'); setupPinInputs('adminSetupPinContainer'); setupPinInputs('adminConfirmPinContainer'); }
        async function saveAdminPin() { const p1=getPin('adminSetupPinContainer'), p2=getPin('adminConfirmPinContainer'); if(p1.length!==4||p1!==p2) return Swal.fire('Error','PINs incorrectos','error'); adminPin=simpleHash(p1); await saveAdminToCloud(adminPin); document.getElementById('adminSetupScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); renderProfiles(); }
        function renderProfiles() {
            const g = document.getElementById('profilesGrid');
            let h = profiles.map((p,i) => `<div class="profile-card" onclick="${isAdminMode ? `openEdit(${i})` : `selectProfile(${i})`}">
                <div class="profile-avatar avatar-${p.color} ${p.pin?'has-lock':''} ${!p.pinConfigured&&!isAdminMode?'new-user':''} ${p.isObserver?'is-observer':''} ${isAdminMode?'border-yellow-500 border-2':''}">
                    ${p.emoji} ${isAdminMode?'<div class="absolute inset-0 bg-black/50 flex items-center justify-center rounded-xl"><i class="fas fa-pencil-alt text-yellow-400"></i></div>':''}
                </div><p class="profile-name">${p.name}</p></div>`).join('');
            if(isAdminMode && profiles.length<12) h+=`<div class="profile-card add-profile-card" onclick="openEdit(-1)"><div class="profile-avatar border-yellow-500 text-yellow-500"><i class="fas fa-plus"></i></div><p class="profile-name text-yellow-400">Crear</p></div>`;
            g.innerHTML = h || '<p class="text-slate-500">Sin perfiles.</p>';
            document.getElementById('btnManageProfiles').innerHTML = isAdminMode ? '<i class="fas fa-check"></i> Salir' : '<i class="fas fa-shield-alt"></i> Administrar';
            document.getElementById('btnManageProfiles').onclick = isAdminMode ? ()=>{isAdminMode=false;renderProfiles()} : requestAdminAccess;
        }
        function requestAdminAccess() { document.getElementById('adminPinModal').classList.remove('hidden'); clearPin('adminPinContainer'); document.querySelector('#adminPinContainer .pin-digit').focus(); document.getElementById('adminPinError').classList.add('hidden'); setupPinInputs('adminPinContainer', verifyAdminPin); }
        function closeAdminPinModal() { document.getElementById('adminPinModal').classList.add('hidden'); }
        function verifyAdminPin() { if(simpleHash(getPin('adminPinContainer'))===adminPin){closeAdminPinModal();isAdminMode=true;renderProfiles();}else{shake('adminPinContainer');document.getElementById('adminPinError').classList.remove('hidden');clearPin('adminPinContainer');} }
        function selectProfile(i) { pendingProfile=profiles[i]; if(!pendingProfile.pinConfigured) openSetupPin(); else if(pendingProfile.pin) openLoginPin(); else {currentUser=pendingProfile; enterApp();} }
        
        // Pin & Profile Modals
        function openLoginPin() { document.getElementById('pinModal').classList.remove('hidden'); document.getElementById('pinAvatarDisplay').innerText=pendingProfile.emoji; document.getElementById('pinAvatarDisplay').className=`w-24 h-24 mx-auto rounded-xl flex items-center justify-center text-5xl mb-4 avatar-${pendingProfile.color}`; document.getElementById('pinUserTitle').innerText=pendingProfile.name; clearPin('loginPin'); document.querySelector('#loginPin .pin-digit').focus(); setupPinInputs('loginPin', verifyLoginPin); }
        function closePinModal() { document.getElementById('pinModal').classList.add('hidden'); pendingProfile=null; }
        function verifyLoginPin() { if(simpleHash(getPin('loginPin'))===pendingProfile.pin){closePinModal();currentUser=pendingProfile;enterApp();}else{shake('loginPin');clearPin('loginPin');} }
        function openSetupPin() { document.getElementById('setupPinModal').classList.remove('hidden'); document.getElementById('setupPinAvatar').innerText=pendingProfile.emoji; document.getElementById('setupPinAvatar').className=`w-20 h-20 rounded-xl mx-auto mb-4 flex items-center justify-center text-4xl avatar-${pendingProfile.color}`; setupPinInputs('setupPinContainer'); setupPinInputs('confirmPinContainer'); }
        async function savePersonalPin() { const p1=getPin('setupPinContainer'), p2=getPin('confirmPinContainer'); if(p1.length!==4||p1!==p2) return shake('confirmPinContainer'); const idx=profiles.findIndex(p=>p.id===pendingProfile.id); profiles[idx].pin=simpleHash(p1); profiles[idx].pinConfigured=true; await saveProfiles(); document.getElementById('setupPinModal').classList.add('hidden'); currentUser=profiles[idx]; enterApp(); }
        async function skipPersonalPin() { const idx=profiles.findIndex(p=>p.id===pendingProfile.id); profiles[idx].pin=null; profiles[idx].pinConfigured=true; await saveProfiles(); document.getElementById('setupPinModal').classList.add('hidden'); currentUser=profiles[idx]; enterApp(); }
        
        // Edit Profile
        function openEdit(i) { const isNew=i===-1; document.getElementById('editProfileModal').classList.remove('hidden'); document.getElementById('editProfileTitle').innerText=isNew?'Nuevo':'Editar'; document.getElementById('editProfileId').value=i; document.getElementById('adminActions').classList.toggle('hidden',isNew); 
            if(isNew){ document.getElementById('profileNameInput').value=''; selectedEmoji='üòÄ'; selectedColor='violet'; document.getElementById('profileIsObserver').checked=false; }
            else{ const p=profiles[i]; document.getElementById('profileNameInput').value=p.name; selectedEmoji=p.emoji; selectedColor=p.color; document.getElementById('profileIsObserver').checked=p.isObserver; }
            renderSelectors();
        }
        function closeEditProfileModal() { document.getElementById('editProfileModal').classList.add('hidden'); }
        function renderSelectors() { document.getElementById('emojiSelector').innerHTML=AVATAR_EMOJIS.map(e=>`<div onclick="selectedEmoji='${e}';renderSelectors()" class="avatar-option avatar-${selectedColor} ${e===selectedEmoji?'selected':''}">${e}</div>`).join(''); document.getElementById('colorSelector').innerHTML=AVATAR_COLORS.map(c=>`<div onclick="selectedColor='${c}';renderSelectors()" class="color-option avatar-${c} ${c===selectedColor?'selected':''}"></div>`).join(''); document.getElementById('previewAvatar').className=`w-24 h-24 mx-auto rounded-xl flex items-center justify-center text-5xl mb-2 transition-all avatar-${selectedColor}`; document.getElementById('previewAvatar').innerText=selectedEmoji; }
        async function saveProfile() { const name=document.getElementById('profileNameInput').value.trim(); if(!name)return; const i=parseInt(document.getElementById('editProfileId').value); const p={name,emoji:selectedEmoji,color:selectedColor,isObserver:document.getElementById('profileIsObserver').checked}; if(i===-1)profiles.push({id:Date.now(),pin:null,pinConfigured:false,...p}); else Object.assign(profiles[i],p); await saveProfiles(); closeEditProfileModal(); renderProfiles(); }
        async function resetUserPin() { profiles[document.getElementById('editProfileId').value].pin=null; profiles[document.getElementById('editProfileId').value].pinConfigured=false; await saveProfiles(); closeEditProfileModal(); Swal.fire('Listo','PIN eliminado','success'); }
        async function deleteProfile() { if((await Swal.fire({title:'¬øBorrar?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',background:'#1e293b',color:'#fff'})).isConfirmed){profiles.splice(document.getElementById('editProfileId').value,1); await saveProfiles(); closeEditProfileModal(); renderProfiles();} }

        // PIN Logic
        function setupPinInputs(id, cb) { const c=document.getElementById(id); c.querySelectorAll('.pin-digit').forEach((inpt,i,arr)=>{ inpt.value=''; inpt.oninput=e=>{e.target.value=e.target.value.replace(/\D/g,''); if(e.target.value){ e.target.classList.add('filled'); if(i<3)arr[i+1].focus(); else if(cb)cb(); }else e.target.classList.remove('filled'); }; inpt.onkeydown=e=>{if(e.key==='Backspace'&&!e.target.value&&i>0)arr[i-1].focus()}; }); }
        function getPin(id) { return Array.from(document.getElementById(id).querySelectorAll('.pin-digit')).map(i=>i.value).join(''); }
        function clearPin(id) { document.getElementById(id).querySelectorAll('.pin-digit').forEach(i=>{i.value='';i.classList.remove('filled','error')}); }
        function shake(id) { const c=document.getElementById(id); c.querySelectorAll('.pin-digit').forEach(i=>i.classList.add('error')); setTimeout(()=>c.querySelectorAll('.pin-digit').forEach(i=>i.classList.remove('error')),500); }

        // Main App Logic
        async function enterApp() {
            document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
            updateCurrentUserBadge(); applyObserverRestrictions();
            await loadAllData(); setupRealtime(); nav('dashboard');
        }
        function updateCurrentUserBadge() {
            if (!currentUser) return;
            const av = document.getElementById('currentUserAvatar'); document.getElementById('currentUserName').innerText = currentUser.name;
            const badge = document.getElementById('currentUserBadge');
            badge.classList.remove('hidden');
            av.className = `w-8 h-8 rounded-md flex items-center justify-center text-lg font-bold avatar-${currentUser.color}`;
            av.innerText = currentUser.emoji;
        }
        function applyObserverRestrictions() {
            const isObs = currentUser && currentUser.isObserver;
            document.getElementById('navRegister').classList.toggle('observer-hidden', isObs);
            document.getElementById('navSettings').classList.toggle('observer-hidden', isObs);
            document.getElementById('mobRegister').classList.toggle('observer-hidden', isObs);
            document.getElementById('mobSettings').classList.toggle('observer-hidden', isObs);
        }
        function logout() { Swal.fire({title:'¬øSalir?',icon:'question',showCancelButton:true,confirmButtonText:'S√≠',cancelButtonText:'No',background:'#1e293b',color:'#fff'}).then(r=>{if(r.isConfirmed){currentUser=null;sessionStorage.removeItem('currentUser');location.reload();}})}
        function nav(id) {
            if(currentUser.isObserver && (id==='register'||id==='settings')) return;
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>{b.classList.remove('active'); if(b.dataset.target===id) b.classList.add('active')});
            if(id==='register') prepareRegister();
            if(id==='justice') renderJusticeModule();
            if(id==='analytics') renderAnalyticsModule();
        }

        // --- DASHBOARD & CHARTS ---
        function updateUI() {
            document.getElementById('kpiTotal').innerText = matches.length;
            const w={}, g={}; matches.forEach(m=>{ w[m.winner]=(w[m.winner]||0)+1; g[m.game]=(g[m.game]||0)+1; });
            renderRankings(w,g); updateCharts(w,g);
            renderHistory();
        }
        function renderRankings(w, g) {
            const sw = Object.entries(w).sort((a,b)=>b[1]-a[1]); const sg = Object.entries(g).sort((a,b)=>b[1]-a[1]);
            document.getElementById('playersRankingList').innerHTML = sw.slice(0,5).map((p,i)=>`<div class="flex justify-between border-b border-slate-700 py-1 text-sm"><span>#${i+1} <b class="text-neon-cyan">${p[0]}</b></span><span>${p[1]} wins</span></div>`).join('');
            if(sw[0]) { document.getElementById('kpiMVPName').innerText=sw[0][0]; document.getElementById('kpiMVPWins').innerText=sw[0][1]+' wins'; }
            document.getElementById('gamesRankingList').innerHTML = sg.slice(0,5).map((p,i)=>`<div class="flex justify-between border-b border-slate-700 py-1 text-sm"><span>#${i+1} <b class="text-neon-pink">${p[0]}</b></span><span>${p[1]} plays</span></div>`).join('');
            if(sg[0]) { document.getElementById('kpiGameName').innerText=sg[0][0]; document.getElementById('kpiGameCount').innerText=sg[0][1]+' plays'; }
        }
        function toggleRanking(t) { document.getElementById(t+'Ranking').classList.toggle('expanded'); }

        // --- JUSTICE MODULE (RESTAURADO) ---
        function renderJusticeModule() {
            const map={}; matches.forEach(m=>{ const d=m.played_date||m.created_at.split('T')[0]; if(!map[d])map[d]=new Set(); m.players.forEach(p=>map[d].add(p)); });
            const dates = Object.keys(map).sort().reverse();
            const wall = document.getElementById('wallOfShameCard');
            const alert = document.getElementById('dashboardAlert');
            
            if(dates.length < 3) {
                wall.className = 'glass p-6 rounded-2xl text-center text-slate-500';
                wall.innerHTML = 'Se necesitan 3 fechas para calcular sanciones.';
                alert.classList.add('hidden');
            } else {
                const l3 = dates.slice(0,3);
                const offenders = config.players.filter(p=> !map[l3[0]].has(p.nickname) && !map[l3[1]].has(p.nickname) && !map[l3[2]].has(p.nickname)).map(p=>p.nickname);
                if(offenders.length > 0) {
                    wall.className = 'glass-danger p-6 rounded-2xl animate-pulse text-center';
                    wall.innerHTML = `<h3 class="text-2xl text-red-500 font-gaming mb-4"><i class="fas fa-skull"></i> WALL OF SHAME</h3><div class="flex flex-wrap justify-center gap-3">${offenders.map(o=>`<span class="offender-badge">${o}</span>`).join('')}</div>`;
                    alert.classList.remove('hidden');
                } else {
                    wall.className = 'glass-success p-6 rounded-2xl text-center';
                    wall.innerHTML = '<h3 class="text-emerald-400 font-gaming text-xl">Zona Segura</h3><p class="text-sm">Nadie tiene 3 faltas consecutivas.</p>';
                    alert.classList.add('hidden');
                }
            }
            
            document.getElementById('absenceBoard').innerHTML = dates.map(d => {
                const absent = config.players.filter(p => !map[d].has(p.nickname)).map(p => p.nickname);
                const badges = absent.length ? absent.map(a => `<span class="text-[10px] border border-red-500 bg-red-900/50 text-red-300 px-2 py-0.5 rounded shadow-[0_0_5px_red]">${a}</span>`).join(' ') : '<span class="text-emerald-400 text-xs">Asistencia Perfecta</span>';
                return `<div class="flex justify-between items-center p-3 bg-slate-800/50 rounded border border-slate-700 mb-2">
                    <div class="text-xs bg-slate-700 px-2 py-1 rounded text-white">${new Date(d).toLocaleDateString('es-ES',{day:'2-digit',month:'short'})}</div>
                    <div class="flex flex-wrap justify-end gap-1 flex-1 ml-4">${badges}</div>
                </div>`;
            }).join('');
        }

        // --- ANALYTICS ---
        function renderAnalyticsModule() {
            const s={}; matches.forEach(m=>{ m.players.forEach(p=>{ if(!s[p])s[p]={p:0,w:0}; s[p].p++; if(m.winner===p)s[p].w++; }); });
            const r = Object.keys(s).map(k=>({n:k, ...s[k], r:((s[k].w/s[k].p)*100).toFixed(1)})).filter(x=>x.p>=3).sort((a,b)=>b.r-a.r);
            const ctx = document.getElementById('chartWinRate');
            if(window.myWinChart) window.myWinChart.destroy();
            window.myWinChart = new Chart(ctx, { type:'bar', data:{labels:r.map(x=>x.n), datasets:[{label:'Win %', data:r.map(x=>x.r), backgroundColor:r.map(x=>x.r>50?'#10b981':(x.r>25?'#f59e0b':'#ef4444')), borderRadius:4}]}, options:{indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{max:100, ticks:{color:'#94a3b8'}}, y:{ticks:{color:'#fff'}}}} });
            document.getElementById('analyticsTable').innerHTML = r.map((x,i)=>`<div class="flex justify-between p-3 bg-slate-800 rounded border border-slate-700"><div><span class="text-slate-500 mr-2">#${i+1}</span><span class="font-bold">${x.n}</span></div><div class="text-right"><div class="${x.r>50?'text-emerald-400':(x.r>25?'text-amber-400':'text-red-400')} font-bold">${x.r}%</div><div class="text-[10px] text-slate-500">${x.w}/${x.p} wins</div></div></div>`).join('');
        }

        // --- REGISTER & HISTORY ---
        function prepareRegister() {
            document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('inputNotes').value = '';
            document.getElementById('inputGame').innerHTML = '<option>Selecciona...</option>' + config.games.map(g => `<option value="${g.name}" data-type="${g.type}">${g.name}</option>`).join('');
            document.getElementById('gridPlayers').innerHTML = config.players.map(p => `<div onclick="toggleP('${p.nickname}',this)" class="cursor-pointer bg-slate-800 border border-slate-600 p-2 rounded text-center text-xs select-none text-slate-400">${p.nickname}</div>`).join('');
            activePlayers = []; updateGameMode();
        }
        function toggleP(n,el) {
            if(activePlayers.includes(n)) { activePlayers=activePlayers.filter(x=>x!==n); el.className="cursor-pointer bg-slate-800 border border-slate-600 p-2 rounded text-center text-xs select-none text-slate-400"; }
            else { activePlayers.push(n); el.className="cursor-pointer bg-neon-violet text-white p-2 rounded text-center text-xs font-bold shadow-[0_0_10px_#a855f7]"; }
            updateGameMode();
        }
        function updateGameMode() {
            const t = document.getElementById('inputGame').selectedOptions[0]?.dataset.type || 'direct';
            const sc = document.getElementById('sectionScores'); const ws = document.getElementById('inputWinner');
            if(t==='score') { sc.classList.remove('hidden'); ws.disabled=true; ws.innerHTML='<option>Auto</option>'; document.getElementById('gridScores').innerHTML=activePlayers.map(p=>`<div class="bg-slate-900 p-2 rounded"><div class="text-xs text-slate-400">${p}</div><input type="number" data-p="${p}" class="sc-inp w-full bg-transparent text-center font-bold text-white" oninput="calcW()"></div>`).join(''); }
            else { sc.classList.add('hidden'); ws.disabled=false; ws.innerHTML='<option>Ganador...</option>'+activePlayers.map(p=>`<option value="${p}">${p}</option>`).join(''); }
        }
        function calcW() { let m=-999,w=null; document.querySelectorAll('.sc-inp').forEach(i=>{const v=parseInt(i.value)||0; if(v>m){m=v;w=i.dataset.p}}); if(w)document.getElementById('inputWinner').innerHTML=`<option value="${w}" selected>üèÜ ${w} (${m})</option>`; }
        async function submitMatch() {
            const g=document.getElementById('inputGame').value, w=document.getElementById('inputWinner').value, n=document.getElementById('inputNotes').value, d=document.getElementById('inputDate').value, eid=document.getElementById('editMatchId').value;
            let sc={}; document.querySelectorAll('.sc-inp').forEach(i=>sc[i.dataset.p]=parseInt(i.value)||0);
            if(!g||!w||activePlayers.length<1) return Swal.fire('Faltan datos','','warning');
            const pl={game:g,winner:w,players:activePlayers,notes:n,scores:Object.keys(sc).length?sc:null,played_date:d};
            if(eid) await sbClient.from('matches').update(pl).eq('id',eid); else await sbClient.from('matches').insert([pl]);
            cancelEditMatch(); nav('dashboard'); Swal.fire({icon:'success',title:'Guardado',timer:1000,showConfirmButton:false});
        }
        function renderHistory() {
            const isObs = currentUser.isObserver;
            document.getElementById('listHistory').innerHTML = matches.map(m => `<div class="glass p-3 rounded-xl mb-2 flex justify-between border-l-4 border-neon-cyan"><div onclick="showDetail(${m.id})" class="flex-1 cursor-pointer"><div>${new Date(m.played_date||m.created_at).toLocaleDateString()} ‚Ä¢ ${m.game}</div><div class="font-bold text-white">${m.winner}</div></div>${!isObs?`<div class="flex gap-2"><button onclick="loadEdit(${m.id})" class="text-slate-400"><i class="fas fa-edit"></i></button><button onclick="delMatch(${m.id},event)" class="text-red-400"><i class="fas fa-trash"></i></button></div>`:''}</div>`).join('');
        }
        function showDetail(id) { const m=matches.find(x=>x.id===id); if(!m)return; Swal.fire({title:m.game, html:m.players.map(p=>`<div class="flex justify-between border-b border-slate-700 p-2"><span>${p===m.winner?'üëë':''} ${p}</span><span>${m.scores?m.scores[p]:'-'}</span></div>`).join('')+(m.notes?`<p class="mt-4 text-xs italic">"${m.notes}"</p>`:''), background:'#1e293b', color:'#fff'}); }
        function loadEdit(id) { const m=matches.find(x=>x.id===id); if(!m)return; document.getElementById('editMatchId').value=id; document.getElementById('editModeBanner').classList.remove('hidden'); document.getElementById('registerTitle').innerText='Editar'; document.getElementById('btnSubmitMatch').innerText='ACTUALIZAR'; prepareRegister(); document.getElementById('inputDate').value=m.played_date; document.getElementById('inputGame').value=m.game; document.getElementById('inputNotes').value=m.notes; activePlayers=[...m.players]; document.querySelectorAll('#gridPlayers > div').forEach(el=>{if(activePlayers.includes(el.innerText))el.click()}); updateGameMode(); nav('register'); }
        function cancelEditMatch() { document.getElementById('editMatchId').value=''; document.getElementById('editModeBanner').classList.add('hidden'); document.getElementById('registerTitle').innerText='Nueva Partida'; document.getElementById('btnSubmitMatch').innerText='GUARDAR'; prepareRegister(); }
        async function delMatch(id,e) { e.stopPropagation(); if((await Swal.fire({title:'¬øBorrar?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',background:'#1e293b',color:'#fff'})).isConfirmed) await sbClient.from('matches').delete().eq('id',id); }

        // Settings
        function renderSettings() { document.getElementById('listPlayers').innerHTML=config.players.map((p,i)=>`<div class="flex justify-between bg-slate-800 p-2 rounded mb-1 text-xs"><span>${p.nickname}</span><div><i onclick="loadP(${i})" class="fas fa-edit mr-2 cursor-pointer"></i><i onclick="remP(${i})" class="fas fa-trash text-red-400 cursor-pointer"></i></div></div>`).join(''); document.getElementById('listGames').innerHTML=config.games.map((g,i)=>`<div class="flex justify-between bg-slate-800 p-2 rounded mb-1 text-xs"><span>${g.name}</span><div><i onclick="loadG(${i})" class="fas fa-edit mr-2 cursor-pointer"></i><i onclick="remG(${i})" class="fas fa-trash text-red-400 cursor-pointer"></i></div></div>`).join(''); }
        function savePlayer() { const n=document.getElementById('playerNick').value, r=document.getElementById('playerReal').value, i=parseInt(document.getElementById('editPlayerIndex').value); if(!n)return; if(i===-1)config.players.push({nickname:n,realName:r}); else {config.players[i].nickname=n;config.players[i].realName=r;} cancelP(); saveConfig(); }
        function loadP(i) { const p=config.players[i]; document.getElementById('playerNick').value=p.nickname; document.getElementById('playerReal').value=p.realName; document.getElementById('editPlayerIndex').value=i; document.getElementById('btnSavePlayer').innerText='ACTUALIZAR'; document.getElementById('btnCancelEditPlayer').classList.remove('hidden'); }
        function cancelP() { document.getElementById('playerNick').value=''; document.getElementById('playerReal').value=''; document.getElementById('editPlayerIndex').value=-1; document.getElementById('btnSavePlayer').innerText='AGREGAR'; document.getElementById('btnCancelEditPlayer').classList.add('hidden'); }
        function remP(i) { config.players.splice(i,1); saveConfig(); }
        function setGameType(t) { selectedGameType=t; document.getElementById('btnTypeDirect').className=t==='direct'?'flex-1 text-xs py-2 border rounded font-bold border-neon-cyan text-neon-cyan':'flex-1 text-xs py-2 border rounded border-slate-600 text-slate-400'; document.getElementById('btnTypeScore').className=t==='score'?'flex-1 text-xs py-2 border rounded font-bold border-neon-pink text-neon-pink':'flex-1 text-xs py-2 border rounded border-slate-600 text-slate-400'; }
        function saveGame() { const n=document.getElementById('newGameName').value, i=parseInt(document.getElementById('editGameIndex').value); if(!n)return; if(i===-1)config.games.push({name:n,type:selectedGameType}); else {config.games[i].name=n;config.games[i].type=selectedGameType;} cancelG(); saveConfig(); }
        function loadG(i) { const g=config.games[i]; document.getElementById('newGameName').value=g.name; setGameType(g.type); document.getElementById('editGameIndex').value=i; document.getElementById('btnSaveGame').innerText='ACTUALIZAR'; document.getElementById('btnCancelEditGame').classList.remove('hidden'); }
        function cancelG() { document.getElementById('newGameName').value=''; setGameType('direct'); document.getElementById('editGameIndex').value=-1; document.getElementById('btnSaveGame').innerText='AGREGAR'; document.getElementById('btnCancelEditGame').classList.add('hidden'); }
        function remG(i) { config.games.splice(i,1); saveConfig(); }

        let chartWins, chartGames;
        function initCharts() { Chart.defaults.color='#64748b'; Chart.defaults.borderColor='#334155'; chartWins=new Chart(document.getElementById('chartWins'),{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#a855f7','#22d3ee','#ec4899','#f59e0b','#10b981'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}}); chartGames=new Chart(document.getElementById('chartGames'),{type:'bar',data:{labels:[],datasets:[{label:'Partidas',data:[],backgroundColor:'#3b82f6',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}}}}}); }
        function updateCharts(w,g) { chartWins.data.labels=Object.keys(w); chartWins.data.datasets[0].data=Object.values(w); chartWins.update(); chartGames.data.labels=Object.keys(g); chartGames.data.datasets[0].data=Object.values(g); chartGames.update(); }
    </script>
</body>
</html>
