<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üé≤ Boardgame Tracker - Organized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { 'gaming': ['Orbitron', 'sans-serif'], 'body': ['Inter', 'sans-serif'] }, colors: { 'neon-violet': '#a855f7', 'neon-cyan': '#22d3ee', 'neon-pink': '#ec4899', 'neon-red': '#ef4444', 'dark-bg': '#0f172a' } } } }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-danger { background: rgba(69, 10, 10, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(239, 68, 68, 0.3); box-shadow: 0 0 20px rgba(239, 68, 68, 0.1); }
        .glass-success { background: rgba(6, 78, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(16, 185, 129, 0.3); }
        .bg-orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.2; z-index: -1; animation: float 10s ease-in-out infinite; }
        .section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .section.active { display: block; opacity: 1; }
        .nav-btn.active { color: #22d3ee; background: rgba(34, 211, 238, 0.1); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2); }
        .swal2-popup { background: #1e293b !important; border: 1px solid #334155 !important; color: #fff !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body class="pb-24 md:pb-0 md:pl-64 min-h-screen overflow-x-hidden">

    <div class="bg-orb w-64 h-64 bg-purple-600 top-0 left-0"></div>
    <div class="bg-orb w-96 h-96 bg-cyan-600 bottom-0 right-0" style="animation-delay: -5s"></div>

    <header class="md:hidden glass sticky top-0 z-50 p-4 flex justify-between items-center">
        <div class="flex items-center gap-2"><i class="fas fa-dice-d20 text-neon-cyan text-xl"></i><h1 class="font-gaming font-bold text-lg bg-gradient-to-r from-neon-cyan to-neon-violet bg-clip-text text-transparent">BG TRACKER</h1></div>
        <div id="statusIndicator" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_red]"></div>
    </header>

    <nav class="hidden md:flex fixed left-0 top-0 h-full w-64 glass flex-col p-6 z-40 border-r border-slate-800">
        <div class="flex items-center gap-3 mb-10"><div class="w-10 h-10 rounded-lg bg-gradient-to-br from-neon-violet to-neon-cyan flex items-center justify-center"><i class="fas fa-dice-d20 text-white"></i></div><div><h1 class="font-gaming font-bold text-lg">BG TRACKER</h1><p id="desktopStatus" class="text-[10px] text-red-400">‚óè Desconectado</p></div></div>
        <div class="flex flex-col gap-2">
            <button onclick="nav('dashboard')" class="nav-btn active flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="dashboard"><i class="fas fa-chart-pie w-5"></i> Dashboard</button>
            <button onclick="nav('justice')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="justice"><i class="fas fa-balance-scale w-5"></i> Justicia</button>
            <button onclick="nav('register')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="register"><i class="fas fa-plus-circle w-5"></i> Nueva Partida</button>
            <button onclick="nav('history')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="history"><i class="fas fa-history w-5"></i> Historial</button>
            <button onclick="nav('settings')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 transition-all text-left text-sm font-medium" data-target="settings"><i class="fas fa-cog w-5"></i> Configuraci√≥n</button>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-8">
        <section id="dashboard" class="section active">
            <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span class="text-neon-violet">üìä</span> Estad√≠sticas</h2>
            <div id="dashboardAlert" class="hidden mb-6 bg-red-500/10 border border-red-500/50 p-3 rounded-xl flex items-center justify-between cursor-pointer hover:bg-red-500/20 transition-all" onclick="nav('justice')"><div class="flex items-center gap-3"><div class="animate-pulse w-2 h-2 bg-red-500 rounded-full"></div><span class="text-red-300 text-sm font-bold">¬°Hay sanciones activas!</span></div><i class="fas fa-chevron-right text-red-400"></i></div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="glass p-4 rounded-2xl"><p class="text-slate-400 text-xs uppercase">Partidas</p><p id="kpiTotal" class="font-gaming text-3xl mt-1">0</p></div>
                <div class="glass p-4 rounded-2xl"><p class="text-slate-400 text-xs uppercase">MVP</p><p id="kpiMVP" class="font-gaming text-xl mt-1 truncate text-neon-cyan">-</p></div>
                <div class="glass p-4 rounded-2xl col-span-2 md:col-span-2"><p class="text-slate-400 text-xs uppercase">Juego Favorito</p><p id="kpiGame" class="font-gaming text-xl mt-1 truncate text-neon-pink">-</p></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="glass p-5 rounded-2xl"><h3 class="text-sm font-bold mb-4 text-slate-300">Victorias</h3><div class="h-48"><canvas id="chartWins"></canvas></div></div>
                <div class="glass p-5 rounded-2xl"><h3 class="text-sm font-bold mb-4 text-slate-300">Juegos</h3><div class="h-48"><canvas id="chartGames"></canvas></div></div>
            </div>
        </section>

        <section id="justice" class="section">
            <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2 text-neon-red"><span class="text-3xl">‚öñÔ∏è</span> Sala de Justicia</h2>
            <div id="wallOfShameCard" class="mb-8 p-6 rounded-2xl transition-all duration-500"></div>
            <div class="glass p-6 rounded-2xl"><h3 class="font-gaming text-lg mb-4 text-slate-300 flex items-center gap-2"><i class="fas fa-calendar-times text-slate-500"></i> Bit√°cora de Ausencias</h3><div id="absenceBoard" class="space-y-3 max-h-[500px] overflow-y-auto pr-2"><div class="text-center text-slate-500 py-4">Cargando datos...</div></div></div>
        </section>

        <section id="register" class="section">
            <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span class="text-neon-cyan">üéØ</span> Nueva Partida</h2>
            <div class="glass p-6 rounded-2xl max-w-xl mx-auto">
                <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Fecha</label><input type="date" id="inputDate" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white"></div>
                <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Juego</label><select id="inputGame" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white" onchange="updateGameMode()"><option value="">Selecciona...</option></select><p id="gameModeHint" class="text-xs mt-2 text-neon-pink hidden"><i class="fas fa-calculator"></i> Modo Puntos</p></div>
                <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Participantes</label><div id="gridPlayers" class="grid grid-cols-3 gap-2"></div><p id="msgNoPlayers" class="text-xs text-red-400 mt-2 hidden">Cargando jugadores...</p></div>
                <div id="sectionScores" class="mb-5 hidden"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Puntajes</label><div id="gridScores" class="grid grid-cols-2 gap-3"></div></div>
                <div class="mb-5"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Ganador</label><select id="inputWinner" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white disabled:opacity-50" disabled><option value="">Selecciona jugadores...</option></select></div>
                <div class="mb-6"><label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Notas</label><textarea id="inputNotes" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white text-sm" rows="2" placeholder="Comentarios..."></textarea></div>
                <button onclick="submitMatch()" class="w-full py-4 bg-gradient-to-r from-neon-violet to-neon-cyan rounded-xl font-gaming font-bold text-black hover:scale-[1.02] transition-transform">GUARDAR PARTIDA</button>
            </div>
        </section>

        <section id="history" class="section">
            <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span class="text-neon-pink">üìú</span> Historial</h2>
            <div id="listHistory" class="space-y-3 pb-20"><div class="text-center py-10 text-slate-500">Cargando datos...</div></div>
        </section>

        <section id="settings" class="section">
            <h2 class="font-gaming text-2xl mb-6 flex items-center gap-2"><span class="text-slate-400">‚öôÔ∏è</span> Ajustes</h2>
            <div class="mb-6 bg-blue-900/20 border border-blue-500/30 p-4 rounded-xl text-center"><p class="text-sm text-blue-200">‚òÅÔ∏è <strong>Sincronizaci√≥n Total:</strong> Los cambios que hagas aqu√≠ se ver√°n en todos los dispositivos.</p></div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="glass p-5 rounded-2xl"><h3 class="font-bold mb-4 text-neon-cyan"><i class="fas fa-users"></i> Jugadores</h3><div class="bg-slate-800/50 p-3 rounded-xl mb-4 border border-slate-700"><input type="hidden" id="editPlayerIndex" value="-1"><div class="grid grid-cols-2 gap-2 mb-2"><input id="playerNick" type="text" placeholder="Nickname" class="bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm text-white w-full"><input id="playerReal" type="text" placeholder="Nombre Real" class="bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm text-white w-full"></div><button id="btnSavePlayer" onclick="savePlayer()" class="w-full bg-slate-700 hover:bg-neon-cyan/50 hover:text-white text-slate-300 py-2 rounded-lg text-xs font-bold transition-colors">AGREGAR JUGADOR</button><button id="btnCancelEdit" onclick="cancelEditPlayer()" class="w-full mt-1 text-red-400 text-xs hidden">Cancelar</button></div><div id="listPlayers" class="flex flex-col gap-2 max-h-60 overflow-y-auto pr-1"></div></div>
                <div class="glass p-5 rounded-2xl"><h3 class="font-bold mb-4 text-neon-violet"><i class="fas fa-dice"></i> Juegos</h3><div class="flex gap-2 mb-4"><input id="newGameName" type="text" placeholder="Nombre del juego" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg p-2 text-sm"><button onclick="addGame()" class="bg-slate-700 px-4 rounded-lg hover:bg-slate-600"><i class="fas fa-plus"></i></button></div><div id="listGames" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div></div>
            </div>
        </section>
    </main>

    <nav class="md:hidden fixed bottom-0 w-full glass border-t border-slate-800 p-2 z-50 flex justify-around">
        <button onclick="nav('dashboard')" class="nav-btn active flex flex-col items-center p-2 rounded-lg text-xs" data-target="dashboard"><i class="fas fa-chart-pie text-lg mb-1"></i></button>
        <button onclick="nav('justice')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="justice"><i class="fas fa-balance-scale text-lg mb-1"></i></button>
        <button onclick="nav('register')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="register"><i class="fas fa-plus-circle text-2xl mb-1 text-neon-cyan"></i></button>
        <button onclick="nav('history')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="history"><i class="fas fa-history text-lg mb-1"></i></button>
        <button onclick="nav('settings')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-xs" data-target="settings"><i class="fas fa-cog text-lg mb-1"></i></button>
    </nav>

    <script>
        const SB_URL = 'https://fgdeurowjawiseehoetr.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnZGV1cm93amF3aXNlZWhvZXRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDgxMjksImV4cCI6MjA4MzcyNDEyOX0.abfEkpQgjUXfr0BVeu-6s6dRBxAIqyALfu0ILdLk7VA';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        let config = { players: [], games: [] };
        let matches = [];
        let activePlayers = [];

        document.addEventListener('DOMContentLoaded', async () => {
            initCharts(); await loadAllData(); setupRealtime(); nav('dashboard');
        });

        async function loadAllData() {
            setOnlineStatus(false);
            try {
                const { data: configData, error: configError } = await sbClient.from('app_config').select('data').eq('key', 'main_config').single();
                if (configData) { 
                    config = configData.data; 
                    // ORDENAR AL CARGAR
                    config.players.sort((a, b) => a.nickname.localeCompare(b.nickname));
                    config.games.sort((a, b) => a.name.localeCompare(b.name));
                }
                const { data: matchesData, error: matchesError } = await sbClient.from('matches').select('*').order('played_date', { ascending: false }).order('created_at', { ascending: false });
                if (matchesData) { matches = matchesData; }

                if (!configError && !matchesError) {
                    setOnlineStatus(true);
                    updateUI(); renderJusticeModule(); renderSettings();
                } else { console.error(configError, matchesError); }
            } catch (e) { console.error(e); }
        }

        async function saveConfigToCloud() {
            // ORDENAR ANTES DE GUARDAR
            config.players.sort((a, b) => a.nickname.localeCompare(b.nickname));
            config.games.sort((a, b) => a.name.localeCompare(b.name));
            
            const { error } = await sbClient.from('app_config').upsert({ key: 'main_config', data: config }, { onConflict: 'key' });
            if (error) Swal.fire('Error', error.message, 'error');
            else renderSettings();
        }

        function setupRealtime() {
            sbClient.channel('public:all')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, () => { loadAllData(); toast('Partidas actualizadas'); })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'app_config' }, () => { loadAllData(); toast('Configuraci√≥n actualizada'); })
                .subscribe();
        }
        function toast(msg) { Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: msg, showConfirmButton: false, timer: 2000 }); }

        function setOnlineStatus(isOnline) {
            const ind = document.getElementById('statusIndicator'); const desk = document.getElementById('desktopStatus');
            if(isOnline) { if(ind) ind.classList.replace('bg-red-500','bg-green-500'); if(desk) { desk.innerText='‚óè Conectado'; desk.className='text-[10px] text-green-400'; } } 
            else { if(ind) ind.classList.replace('bg-green-500','bg-red-500'); if(desk) { desk.innerText='‚óè Desconectado'; desk.className='text-[10px] text-red-400'; } }
        }

        function renderJusticeModule() {
            const datesMap = {}; matches.forEach(m => { const d = m.played_date || m.created_at.split('T')[0]; if (!datesMap[d]) datesMap[d] = new Set(); m.players.forEach(p => datesMap[d].add(p)); });
            const uniqueDates = Object.keys(datesMap).sort().reverse();
            const wallDiv = document.getElementById('wallOfShameCard'); const alertDiv = document.getElementById('dashboardAlert');

            if (uniqueDates.length < 3) {
                wallDiv.className = 'glass p-6 rounded-2xl text-center'; wallDiv.innerHTML = `<h3 class="text-slate-400 font-bold mb-2">Datos Insuficientes</h3><p class="text-xs text-slate-500">Se necesitan 3 fechas para calcular sanciones.</p>`; alertDiv.classList.add('hidden');
            } else {
                const last3 = uniqueDates.slice(0, 3); const offenders = [];
                config.players.forEach(obj => { const p = obj.nickname; if (!datesMap[last3[0]].has(p) && !datesMap[last3[1]].has(p) && !datesMap[last3[2]].has(p)) offenders.push(p); });
                if (offenders.length > 0) {
                    wallDiv.className = 'glass-danger p-6 rounded-2xl border border-red-500 animate-pulse'; wallDiv.innerHTML = `<h3 class="font-gaming text-2xl text-red-500 mb-2 flex items-center justify-center gap-3"><i class="fas fa-skull"></i> WALL OF SHAME</h3><p class="text-red-200 text-sm text-center mb-4">Ausentes 3 fechas seguidas:</p><div class="flex flex-wrap justify-center gap-3">${offenders.map(o => `<span class="bg-red-900 text-red-200 px-4 py-2 rounded-full font-bold border border-red-500">${o}</span>`).join('')}</div>`; alertDiv.classList.remove('hidden');
                } else {
                    wallDiv.className = 'glass-success p-6 rounded-2xl text-center'; wallDiv.innerHTML = `<h3 class="font-gaming text-emerald-400 text-xl mb-2"><i class="fas fa-check-circle"></i> Zona Segura</h3><p class="text-emerald-200 text-sm">Nadie tiene 3 faltas consecutivas.</p>`; alertDiv.classList.add('hidden');
                }
            }
            const boardDiv = document.getElementById('absenceBoard');
            if(uniqueDates.length === 0) { boardDiv.innerHTML = '<p class="text-center text-slate-500">Sin datos</p>'; return; }
            boardDiv.innerHTML = uniqueDates.map(date => {
                const presentSet = datesMap[date]; const absentList = config.players.filter(obj => !presentSet.has(obj.nickname)).map(obj => obj.nickname);
                const [y,m,d] = date.split('-'); const dObj = new Date(y, m-1, d); const niceDate = dObj.toLocaleDateString('es-ES', {weekday:'short',day:'numeric',month:'short'});
                return `<div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700"><div class="flex items-center gap-3 min-w-[80px]"><div class="bg-slate-700 px-2 py-1 rounded text-xs font-bold text-slate-300 text-center">${niceDate}</div></div><div class="flex-1 text-right">${absentList.length > 0 ? `<div class="flex flex-wrap justify-end gap-1">${absentList.map(a => `<span class="text-[10px] bg-red-900/40 text-red-300 px-2 py-0.5 rounded border border-red-900">${a}</span>`).join('')}</div>` : `<span class="text-xs text-emerald-400 font-bold">Asistencia Perfecta</span>`}</div></div>`;
            }).join('');
        }

        function nav(id) { document.querySelectorAll('.section').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e => { e.classList.remove('active'); if(e.dataset.target===id) e.classList.add('active'); }); if(id==='register') prepareRegisterForm(); if(id==='justice') renderJusticeModule(); }

        function updateUI() {
            document.getElementById('kpiTotal').innerText = matches.length;
            if(matches.length > 0) {
                const wins={}, games={}; matches.forEach(m => { wins[m.winner]=(wins[m.winner]||0)+1; games[m.game]=(games[m.game]||0)+1; });
                const maxW = Math.max(...Object.values(wins)); const maxG = Math.max(...Object.values(games));
                document.getElementById('kpiMVP').innerText = `${Object.keys(wins).filter(p=>wins[p]===maxW).join(' / ')} (${maxW})`;
                document.getElementById('kpiGame').innerText = Object.keys(games).filter(g=>games[g]===maxG).join(' / ');
                updateCharts(wins, games);
            }
            document.getElementById('listHistory').innerHTML = matches.map(m => {
                const dRaw = m.played_date || m.created_at.split('T')[0]; const [y,mo,d] = dRaw.split('-'); const date = new Date(y, mo-1, d).toLocaleDateString('es-ES');
                const score = m.scores && m.scores[m.winner] ? `(${m.scores[m.winner]} pts)` : '';
                return `<div onclick="showMatchDetails(${m.id})" class="cursor-pointer glass p-3 rounded-xl flex justify-between items-center border-l-4 border-neon-cyan hover:bg-slate-800 transition-colors"><div><div class="text-[10px] text-slate-400">${date} ‚Ä¢ ${m.game}</div><div class="font-bold text-white">${m.winner} <span class="text-neon-pink text-xs">${score}</span></div></div><button onclick="deleteMatch(${m.id}, event)" class="bg-slate-700 hover:bg-red-500 text-white p-2 rounded-lg transition-colors z-20"><i class="fas fa-trash"></i></button></div>`;
            }).join('');
        }

        async function deleteMatch(id, event) {
            event.stopPropagation();
            if((await Swal.fire({title:'¬øBorrar partida?',text:"Afectar√° las estad√≠sticas.",icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',background:'#1e293b',color:'#fff'})).isConfirmed) {
                await sbClient.from('matches').delete().eq('id', id);
            }
        }

        function showMatchDetails(id) {
            const m = matches.find(x => x.id === id); if(!m) return;
            let html = `<div class="text-left space-y-2">`;
            [...m.players].sort((a,b) => { if(a===m.winner) return -1; if(b===m.winner) return 1; if(m.scores) return (m.scores[b]||0) - (m.scores[a]||0); return 0; }).forEach(p => {
                const isW = p === m.winner; const sc = m.scores ? (m.scores[p]!==undefined ? `${m.scores[p]} pts` : '-') : 'Jug√≥';
                html += `<div class="flex justify-between p-2 rounded border ${isW ? 'bg-neon-cyan/20 border-neon-cyan text-neon-cyan' : 'bg-slate-800 border-slate-700 text-slate-300'}"><span>${isW?'üëë':''} ${p}</span><span>${sc}</span></div>`;
            });
            html += `</div>`; if(m.notes) html += `<div class="mt-4 text-xs italic text-slate-400 p-2 bg-slate-900 rounded">"${m.notes}"</div>`;
            Swal.fire({ title: m.game, html: html, showConfirmButton: false, showCloseButton: true, background: '#1e293b', color: '#fff' });
        }

        function prepareRegisterForm() {
            document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
            const s = document.getElementById('inputGame'); s.innerHTML='<option value="">Selecciona...</option>';
            config.games.forEach(g=>s.innerHTML+=`<option value="${g.name}" data-type="${g.type}">${g.name}</option>`);
            const gp = document.getElementById('gridPlayers');
            if(config.players.length===0) { document.getElementById('msgNoPlayers').classList.remove('hidden'); gp.innerHTML=''; }
            else { document.getElementById('msgNoPlayers').classList.add('hidden'); gp.innerHTML=config.players.map(obj => `<div onclick="togglePlayer('${obj.nickname}',this)" class="cursor-pointer bg-slate-800 border border-slate-600 p-2 rounded-lg text-center text-xs text-slate-300 select-none">${obj.nickname}</div>`).join(''); }
            activePlayers=[]; updateGameMode();
        }
        function togglePlayer(n,e) {
            if(activePlayers.includes(n)) { activePlayers=activePlayers.filter(x=>x!==n); e.className="cursor-pointer bg-slate-800 border border-slate-600 p-2 rounded-lg text-center text-xs text-slate-300 select-none"; }
            else { activePlayers.push(n); e.className="cursor-pointer bg-neon-violet border-transparent text-white p-2 rounded-lg text-center text-xs font-bold select-none shadow-[0_0_10px_#a855f7]"; }
            updateGameMode();
        }
        function updateGameMode() {
            const type = document.getElementById('inputGame').options[document.getElementById('inputGame').selectedIndex]?.dataset.type || 'direct';
            const scSec = document.getElementById('sectionScores'); const winSel = document.getElementById('inputWinner');
            if(type==='score') { scSec.classList.remove('hidden'); winSel.disabled=true; winSel.innerHTML='<option>Autom√°tico...</option>'; document.getElementById('gridScores').innerHTML = activePlayers.map(p=>`<div class="bg-slate-900 p-2 rounded border border-slate-700"><div class="text-[10px] text-slate-400">${p}</div><input type="number" data-player="${p}" class="score-input w-full bg-transparent text-center font-bold text-white text-lg" placeholder="0" oninput="calcWinner()"></div>`).join(''); } 
            else { scSec.classList.add('hidden'); winSel.disabled=false; winSel.innerHTML='<option value="">Ganador...</option>'; activePlayers.forEach(p=>winSel.innerHTML+=`<option value="${p}">${p}</option>`); }
        }
        function calcWinner() { let max=-999; let w=null; document.querySelectorAll('.score-input').forEach(i=>{ const v=parseInt(i.value)||0; if(v>max){max=v; w=i.dataset.player;} }); if(w) document.getElementById('inputWinner').innerHTML=`<option value="${w}" selected>üèÜ ${w} (${max})</option>`; }
        async function submitMatch() {
            const g=document.getElementById('inputGame').value, n=document.getElementById('inputNotes').value, w=document.getElementById('inputWinner').value, d=document.getElementById('inputDate').value;
            let scores={}; document.querySelectorAll('.score-input').forEach(i=>scores[i.dataset.player]=parseInt(i.value)||0);
            if(!g||!w||activePlayers.length<1) return Swal.fire('Faltan datos','','warning');
            const {error} = await sbClient.from('matches').insert([{game:g,winner:w,players:activePlayers,notes:n,scores:Object.keys(scores).length?scores:null, played_date: d}]);
            if(!error) { Swal.fire({icon:'success',title:'Guardado',timer:1500,showConfirmButton:false}); nav('dashboard'); } else { Swal.fire('Error',error.message,'error'); }
        }

        function renderSettings() {
            document.getElementById('listPlayers').innerHTML=config.players.map((p, idx)=>`<div class="bg-slate-700 px-3 py-2 rounded-lg text-xs flex justify-between items-center border border-slate-600"><div><span class="font-bold text-neon-cyan">${p.nickname}</span>${p.realName ? `<span class="text-[10px] text-slate-400 ml-1">(${p.realName})</span>` : ''}</div><div class="flex gap-2"><i onclick="loadPlayerForEdit(${idx})" class="fas fa-pencil-alt cursor-pointer text-slate-400 hover:text-white"></i><i onclick="removePlayer(${idx})" class="fas fa-trash cursor-pointer text-slate-400 hover:text-red-400"></i></div></div>`).join('');
            document.getElementById('listGames').innerHTML=config.games.map(g=>`<div class="flex justify-between bg-slate-800 p-2 rounded text-xs border border-slate-700"><span>${g.name} <span class="text-[9px] text-slate-500 uppercase">${g.type==='score'?'Puntos':'Directo'}</span></span><i onclick="removeGame('${g.name}')" class="fas fa-trash cursor-pointer text-slate-500 hover:text-red-400"></i></div>`).join('');
        }
        function savePlayer() {
            const nick = document.getElementById('playerNick').value.trim(), real = document.getElementById('playerReal').value.trim(), index = parseInt(document.getElementById('editPlayerIndex').value);
            if(!nick) return Swal.fire('Falta Nickname','','warning');
            if(index === -1) config.players.push({ nickname: nick, realName: real }); else { config.players[index].nickname = nick; config.players[index].realName = real; }
            cancelEditPlayer(); saveConfigToCloud();
        }
        function loadPlayerForEdit(index) { const p = config.players[index]; document.getElementById('playerNick').value = p.nickname; document.getElementById('playerReal').value = p.realName || ''; document.getElementById('editPlayerIndex').value = index; document.getElementById('btnSavePlayer').innerText = 'ACTUALIZAR'; document.getElementById('btnCancelEdit').classList.remove('hidden'); }
        function cancelEditPlayer() { document.getElementById('playerNick').value = ''; document.getElementById('playerReal').value = ''; document.getElementById('editPlayerIndex').value = -1; document.getElementById('btnSavePlayer').innerText = 'AGREGAR JUGADOR'; document.getElementById('btnCancelEdit').classList.add('hidden'); }
        function removePlayer(index) { if(confirm('¬øBorrar?')) { config.players.splice(index, 1); saveConfigToCloud(); } }
        async function addGame() {
            const n=document.getElementById('newGameName').value.trim(); if(!n)return;
            const {value:isS} = await Swal.fire({title:'Tipo',showCancelButton:true,confirmButtonText:'Puntos',cancelButtonText:'Directo',background:'#1e293b',color:'#fff'});
            config.games.push({name:n,type:isS?'score':'direct'}); document.getElementById('newGameName').value=''; saveConfigToCloud();
        }
        function removeGame(n) { config.games=config.games.filter(g=>g.name!==n); saveConfigToCloud(); }
        
        let chartWins, chartGames;
        function initCharts() {
            Chart.defaults.color='#64748b'; Chart.defaults.borderColor='#334155';
            chartWins=new Chart(document.getElementById('chartWins'),{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#a855f7','#22d3ee','#ec4899','#f59e0b','#10b981'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10}}}}});
            chartGames=new Chart(document.getElementById('chartGames'),{type:'bar',data:{labels:[],datasets:[{label:'Partidas',data:[],backgroundColor:'#3b82f6',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}}}}});
        }
        function updateCharts(w,g) { chartWins.data.labels=Object.keys(w); chartWins.data.datasets[0].data=Object.values(w); chartWins.update(); chartGames.data.labels=Object.keys(g); chartGames.data.datasets[0].data=Object.values(g); chartGames.update(); }
    </script>
</body>
</html>
